<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.rawgit.com/konvajs/konva/0.11.1/konva.min.js"></script>
    <meta charset="utf-8">
    <title>Konva Shape Events Demo</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #F0F0F0;
        }
    </style>
</head>

<body>
    <div id="container"></div>
    <script>
        var r = 100; //radius
        var L = r * Math.sqrt(3); // length of equilateral sides
        var cx = 200;
        var cy = 300;
        var h = (Math.sqrt(3) / 2) * L
        var coord = [
            [cx, cy - h + h / 3],
            [cx - L / 2, cy + h / 3],
            [cx + L / 2, cy + h / 3]
        ]
        var totaldist = r * 3
        var budget = 18

        var dims = ['Kleur', 'Vorm', 'Patroon']



        function dist(x1, y1, x2, y2) {
            return Math.sqrt( (x1-x2)*(x1-x2) + (y1-y2)*(y1-y2) );
        }

        function barycentric(x0,y0){
            // For a triangle {(x1,y1), (x2,y2), (x3,y3)} and some point (x0,y0), calculate
            //Then if b1, b2, and b3 are all > 0, (x0,y0) is strictly inside the triangle; if bi = 0 and the other two coordinates are positive, (x0,y0) lies on the edge opposite (xi,yi); if bi and bj = 0, (x0,y0) lies on (xk,yk); if bi < 0, (x0,y0) lies outside the edge opposite (xi,yi); if all three coordinates are negative, something else is wrong. This method does not depend on the cyclic order of the vertices.

            var x1 = coord[0][0]
            var y1 = coord[0][1]
            var x2 = coord[1][0]
            var y2 = coord[1][1]
            var x3 = coord[2][0]
            var y3 = coord[2][1]

            b0 =  (x2 - x1) * (y3 - y1) - (x3 - x1) * (y2 - y1)
            b1 = ((x2 - x0) * (y3 - y0) - (x3 - x0) * (y2 - y0)) / b0
            b2 = ((x3 - x0) * (y1 - y0) - (x1 - x0) * (y3 - y0)) / b0
            b3 = ((x1 - x0) * (y2 - y0) - (x2 - x0) * (y1 - y0)) / b0

            return [b1, b2, b3]
        }






        var stage = new Konva.Stage({
            container: 'container',
            width: 700,
            height: 500
        });

        var layer = new Konva.Layer();


        var triangle = new Konva.RegularPolygon({
            x: cx,
            y: cy,
            sides: 3,
            radius: r,
            //fill: 'white',
            stroke: 'black',
            strokeWidth: 5
        });


        var lines = new Konva.Group({
            x: 0,
            y: 0,
        });

        for (var n = 0; n < 3; n++) {

            var line = new Konva.Line({
                points: [cx, cy, coord[n][0], coord[n][1]],
                name: dims[n],
                stroke: 'gray',
                strokeWidth: 2
            });
            lines.add(line);
        }

        var labels = new Konva.Group({
            x: 0,
            y: 0,
        });
        offsets=[[-20,-60],[-70,0],[20,0]]

        for (var n = 0; n < 3; n++) {
            var label = new Konva.Text({
                x: coord[n][0]+offsets[n][0],
                y: coord[n][1]+offsets[n][1],
                fontFamily: 'Calibri',
                fontSize: 24,
                text: dims[n] + "\n" + String(budget/3),
                fill: 'black'
            });
            labels.add(label);
        }

        var circle = new Konva.Circle({
            x: cx,
            y: cy,
            radius: 7,
            fill: 'orange',
            stroke: 'black',
            strokeWidth: 4
        });
        var beliefs = lines.getChildren()
        var texts = labels.getChildren()


        triangle.on('mouseout', function() {
            circle.setX(cx);
            circle.setY(cy);

            for (i = 0; i < 3; i++) {
                beliefs[i].setPoints([cx, cy, coord[i][0], coord[i][1]]);
                texts[i].setText(dims[i] + "\n" + String(budget/3));
                layer.draw();
            }
        });

        triangle.on('mousemove', function() {
            var mousePos = stage.getPointerPosition();
            var x = mousePos.x;
            var y = mousePos.y;

            var dists = [0, 0, 0];
            var tot = 0;
            var values = barycentric(x,y)
            beliefs = lines.getChildren()

            for (i = 0; i < 3; i++) {
                beliefs[i].setPoints([x, y, coord[i][0], coord[i][1]]);
                texts[i].setText(dims[i] + "\n" + String(Math.round(values[i]*budget)));
            }

            layer.draw();

            circle.setX(x)
            circle.setY(y)



        });




        layer.add(lines);
        layer.add(labels);
        layer.add(circle);
        layer.add(triangle);



        // add the layer to the stage

        stage.add(layer);
    </script>

</body>

</html>
